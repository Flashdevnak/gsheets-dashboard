<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sheets → Dashboard (Auto CSV)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b1020; --text:#e9ecf5; --muted:#a9b0c7; --accent:#7c9cf5; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:#111733;border:1px solid #1e2a55;border-radius:16px;padding:16px 16px 20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 240px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #273464;background:#0f1530;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(180deg,#2a3ea6,#1e2a7a);border:none}
    h1{font-size:22px;margin:0 0 14px}
    .muted{color:var(--muted);font-size:13px}
    canvas{width:100%;height:420px}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #273464;border-radius:999px;font-size:12px;color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Google Sheets → Dashboard <span class="pill">auto CSV</span></h1>
    <div class="card" style="margin-bottom:16px">
      <div class="row">
        <div>
          <label>CSV URL (export?format=csv&gid=...)</label>
          <input id="csvUrl" placeholder="วางลิงก์ CSV ของ Google Sheet ที่เผยแพร่แล้ว">
        </div>
        <div>
          <label>คอลัมน์แกน X (ป้ายกำกับ)</label>
          <select id="xSelect"></select>
        </div>
        <div>
          <label>คอลัมน์ค่า (แกน Y)</label>
          <select id="ySelect" multiple size="4"></select>
        </div>
        <div style="align-self:flex-end">
          <button id="loadBtn">โหลดข้อมูล & อัปเดตกราฟ</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">
        หน้านี้ตั้งค่าเริ่มต้นเป็นชีตของคุณไว้แล้ว — เปิดมาก็โหลดข้อมูลให้อัตโนมัติ ถ้าอยากสลับเป็นชีตอื่น ให้เปลี่ยน URL แล้วกดปุ่ม
      </p>
      <p class="muted small">ทิป: ใช้คอลัมน์แรกเป็นวันที่/ชื่อหมวด และเลือก 1–3 คอลัมน์ตัวเลขเป็นค่าแสดงผล</p>
    </div>

    <div class="card">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <script>
    const els = {
      csvUrl: document.getElementById('csvUrl'),
      xSelect: document.getElementById('xSelect'),
      ySelect: document.getElementById('ySelect'),
      loadBtn: document.getElementById('loadBtn'),
      canvas: document.getElementById('chart')
    };

    let rawData = [], headers = [];
    let chart;

    // === Utilities ===
    function autoDetectNumericColumns(data, hdrs){
      const numericIdx = [];
      for(let c=0;c<hdrs.length;c++){
        let n=0, tot=0;
        for(let r=0;r<Math.min(data.length, 200); r++){
          const v = data[r][c];
          if (v !== null && v !== undefined && v !== '') {
            tot++;
            if (!isNaN(parseFloat(v))) n++;
          }
        }
        if (tot>0 && n/tot >= 0.7) numericIdx.push(c);
      }
      return numericIdx;
    }

    function populateSelectors(){
      els.xSelect.innerHTML = '';
      els.ySelect.innerHTML = '';
      headers.forEach((h, i) => {
        const o1 = document.createElement('option');
        o1.value = i; o1.textContent = h; els.xSelect.appendChild(o1);

        const o2 = document.createElement('option');
        o2.value = i; o2.textContent = h; els.ySelect.appendChild(o2);
      });

      els.xSelect.value = 0; // default X = column 0
      const numericIdx = autoDetectNumericColumns(rawData, headers);
      for(const i of numericIdx.slice(0,3)) {
        const opt = [...els.ySelect.options].find(o => +o.value===i);
        if (opt) opt.selected = true;
      }
    }

    function toDatasets(xIdx, yIdxs) {
      const labels = rawData.map(r => r[xIdx]);
      const datasets = yIdxs.map((idx) => ({
        label: headers[idx],
        data: rawData.map(r => {
          const v = parseFloat(r[idx]);
          return isNaN(v) ? null : v;
        }),
        tension: 0.25,
        pointRadius: 2,
        borderWidth: 2,
      }));
      return {labels, datasets};
    }

    function renderChart(cfg){
      if (chart) chart.destroy();
      chart = new Chart(els.canvas.getContext('2d'), {
        type: 'line',
        data: cfg,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { grid: { color: 'rgba(255,255,255,.05)' }, ticks:{ color:'#cdd3ee'} },
            y: { grid: { color: 'rgba(255,255,255,.05)' }, ticks:{ color:'#cdd3ee'} }
          },
          plugins:{
            legend:{ labels:{ color:'#e9ecf5' } },
            tooltip:{ mode:'index', intersect:false }
          }
        }
      });
    }

    async function loadCSV(url){
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          complete: (res) => resolve(res.data),
          error: (err) => reject(err)
        });
      });
    }

    async function run(){
      const url = els.csvUrl.value.trim();
      if(!url) { alert('ใส่ CSV URL ของชีตก่อนครับ'); return; }
      try{
        const rows = await loadCSV(url);
        headers = rows[0];
        rawData = rows.slice(1);
        populateSelectors();

        const xIdx = +els.xSelect.value;
        const yIdxs = [...els.ySelect.selectedOptions].map(o => +o.value);
        const cfg = toDatasets(xIdx, yIdxs);
        renderChart(cfg);
      }catch(e){
        console.error(e);
        alert('โหลด CSV ไม่สำเร็จ กรุณาตรวจสอบสิทธิ์การเข้าถึงหรือ URL');
      }
    }

    els.loadBtn.addEventListener('click', () => {
      const xIdx = +els.xSelect.value;
      const yIdxs = [...els.ySelect.selectedOptions].map(o => +o.value);
      const cfg = toDatasets(xIdx, yIdxs);
      renderChart(cfg);
    });

    // === Auto-load: embed your sheet's CSV here ===
    const DEFAULT_CSV = "https://docs.google.com/spreadsheets/d/18FhtYVbg5ZwFJXn0oJhb69Lxm8HiAdCs_rboRsJnoP4/export?format=csv&gid=0";

    // Allow override via ?csv=...
    const params = new URLSearchParams(location.search);
    const csvFromParam = params.get('csv');
    els.csvUrl.value = csvFromParam ? decodeURIComponent(csvFromParam) : DEFAULT_CSV;

    // Auto-run on first paint
    window.addEventListener('DOMContentLoaded', run);
  </script>
</body>
</html>
