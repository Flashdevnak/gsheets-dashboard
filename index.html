<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elegant Google Sheets Dashboard ‚Äî Auto Connect (Fixed)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1020; --muted:#A9B0C7; --text:#e9ecf5; --primary:#7C9CF5; --ring: rgba(124,156,245,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin:0; background:radial-gradient(1200px 800px at 10% -10%, #1a2250 0%, transparent 40%),radial-gradient(1000px 700px at 110% 10%, #18315a 0%, transparent 40%), #0b1020; color:var(--text)}
    header{display:flex;align-items:center;gap:12px; padding:22px 28px; position:sticky; top:0; backdrop-filter:blur(8px); background:linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.55) 60%, transparent); z-index:5}
    .wrap{max-width:1200px; margin:0 auto; padding:16px 20px 60px}
    .card{background:linear-gradient(180deg, rgba(17,22,50,.85), rgba(17,22,50,.75)); border:1px solid rgba(255,255,255,.06); border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.35); padding:16px; margin:12px 0}
    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}
    @media(max-width:980px){.col-3,.col-4,.col-6{grid-column:span 12}}
    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    select,input,button{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0d132a; color:var(--text)}
    select:focus,input:focus{box-shadow:0 0 0 3px var(--ring)}
    button{background:linear-gradient(135deg, var(--primary), #5B7BF2); border:none; font-weight:600; cursor:pointer}
    .ghost{background:#0d132a; border:1px solid rgba(255,255,255,.12)}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .kpi{padding:16px; border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.06)}
    .kpi .l{font-size:12px; color:var(--muted)} .kpi .v{font-size:24px; font-weight:700; margin-top:6px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab-btn{padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0d132a; color:var(--text); cursor:pointer}
    .tab-btn.active{background:linear-gradient(135deg,#2c3c84,#1c255a)}
    .tab{display:none} .tab.active{display:block}
    .table-wrap{overflow:auto; max-height:420px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); font-size:13px}
    th{position:sticky; top:0; background:#0f1533; z-index:1; text-align:left}
    .right{text-align:right}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px; background:rgba(124,156,245,.15); color:#cfe0ff; border:1px solid rgba(124,156,245,.3)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <h2 style="margin:0">Elegant Google Sheets Dashboard ‚Äî Auto Connect</h2>
    <span class="chip" id="status">Loading‚Ä¶</span>
  </header>
  <div class="wrap">

    <!-- Filters -->
    <div class="card">
      <div class="row">
        <div class="col-3"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" id="startDate"></div>
        <div class="col-3"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="endDate"></div>
        <div class="col-3"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏´‡∏•‡πà‡∏á)</label><select id="sourceSel"></select></div>
        <div class="col-3"><label>‡∏™‡∏≤‡∏Ç‡∏≤</label><select id="branchSel"></select></div>
        <div class="col-3"><label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</label><select id="productSel"></select></div>
        <div class="col-3"><label>‡∏ó‡∏µ‡∏°</label><select id="teamSel"></select></div>
        <div class="col-3"><label>Top N (‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö)</label><input id="topN" type="number" min="1" value="10"></div>
        <div class="col-3"><label>&nbsp;</label><button id="exportBtn" class="ghost">Export ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (CSV)</button></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="l">‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)</div><div class="v" id="kpiTotal">-</div></div>
      <div class="kpi"><div class="l">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><div class="v" id="kpiCount">-</div></div>
      <div class="kpi"><div class="l">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div class="v" id="kpiMonth">-</div></div>
      <div class="kpi"><div class="l">MoM Change</div><div class="v" id="kpiMoM">-</div></div>
    </div>

    <!-- Tabs & Charts -->
    <div class="card">
      <div class="tabs" id="tabs"></div>
      <div class="tab active" data-tab="trend"><canvas id="trendChart" height="280"></canvas></div>
      <div class="tab" data-tab="branch"><canvas id="branchChart" height="300"></canvas></div>
      <div class="tab" data-tab="product"><canvas id="productChart" height="300"></canvas></div>
      <div class="tab" data-tab="team"><canvas id="teamChart" height="300"></canvas></div>
      <div class="tab" data-tab="donut"><canvas id="donutChart" height="300"></canvas></div>
      <div class="tab" data-tab="table"><div class="table-wrap"><table id="dataTable"><thead></thead><tbody></tbody></table></div></div>
    </div>

    <div class="card" style="font-size:12px;color:#cbd3ea">
      ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ <b>Sheet ID</b> ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô (Lost, damaged) ‚Äî ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à: ‡πÑ‡∏ü‡∏•‡πå ‚Üí ‡πÅ‡∏ä‡∏£‡πå ‚Üí ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö
    </div>

  </div>

<script>
Chart.register(ChartDataLabels);
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (isNaN(n)?'-': Number(n).toLocaleString());
const toISO = (d)=> d.toISOString().slice(0,10);
function parseDateFlexible(s){
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
  // dd/mm/yyyy
  const m=String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
  if(m){const d=+m[1],mo=+m[2]-1,y=(m[3].length===2?+('20'+m[3]):+m[3]); return new Date(y,mo,d);} 
  // dd-mm-yyyy
  const m2=String(s).match(/^(\d{1,2})-(\d{1,2})-(\d{2,4})/);
  if(m2){const d=+m2[1],mo=+m2[2]-1,y=(m2[3].length===2?+('20'+m2[3]):+m2[3]); return new Date(y,mo,d);} 
  const d2=new Date(s); return isNaN(d2)?null:d2;
}
function unique(a){ return Array.from(new Set(a.filter(Boolean))).sort(); }
function groupSum(rows, keyFn, valFn){ const mp=new Map(); for(const r of rows){ const k=keyFn(r); if(k==null) continue; mp.set(k,(mp.get(k)||0)+(valFn(r)||0)); } return Array.from(mp.entries()); }

// ====== AUTO CONFIG (YOUR SHEET) ======
const SHEET_ID = '18FhtYVbg5ZwFJXn0oJhb69Lxm8HiAdCs_rboRsJnoP4';
const SHEETS = ['Lost','Damaged']; // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£

// ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ fallback
function detectCols(headers){
  const h = headers.map(x=> String(x||'').trim());
  const locked = {
    date:   h.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏') ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏' : null,
    value:  h.includes('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô') ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : null,
    branch: h.includes('‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏öResponsible') ? '‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏öResponsible' : null,
    product:h.includes('Package') ? 'Package' : null,
    team:   h.includes('‡∏ó‡∏µ‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') ? '‡∏ó‡∏µ‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : null,
    order:  h.includes('‡πÄ‡∏•‡∏ÇExpress Order') ? '‡πÄ‡∏•‡∏ÇExpress Order' : null,
  };
  const find = (cands)=> h.find(x=> cands.some(c=> x.toLowerCase().includes(c))) || null;
  return {
    date:   locked.date   || find(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','date','‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏','‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö']) || h[0] || null,
    value:  locked.value  || find(['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','amount','value','qty']) || null,
    branch: locked.branch || find(['‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö','branch','responsible']) || null,
    product:locked.product|| find(['package','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','product']) || null,
    team:   locked.team   || find(['‡∏ó‡∏µ‡∏°','team']) || null,
    order:  locked.order  || find(['‡πÄ‡∏•‡∏Ç','order','tracking','express']) || null,
  };
}

async function fetchSheetCSV(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&cachebust=${Date.now()}`;
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ï "${sheetName}" ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (HTTP ${res.status}).\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ\n‚Ä¢ ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß\n‚Ä¢ ‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö: ${SHEETS.join(', ')}`);
  }
  const text = await res.text();
  const parsed = Papa.parse(text, {header:true});
  return parsed.data;
}

let RAW=[], charts={};
const TABS=[
  {id:'trend', label:'üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'},
  {id:'branch', label:'üè¢ ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤'},
  {id:'product', label:'üì¶ ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à'},
  {id:'team', label:'üë• ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°'},
  {id:'donut', label:'üü¢ ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (Donut)'},
  {id:'table', label:'üßæ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á'},
];

(function initTabs(){
  const wrap=$('tabs');
  TABS.forEach(t=>{ const b=document.createElement('button'); b.className='tab-btn'+(t.id==='trend'?' active':''); b.dataset.tab=t.id; b.textContent=t.label; wrap.appendChild(b); });
  wrap.addEventListener('click', e=>{ const b=e.target.closest('.tab-btn'); if(!b) return; document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); const id=b.dataset.tab; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelector(`.tab[data-tab="${id}"]`).classList.add('active'); });
})();

(async function bootstrap(){
  try{
    $('status').textContent='Connecting‚Ä¶';
    const allRows = [];
    for(const name of SHEETS){
      const rows = await fetchSheetCSV(name);
      if(!rows || !rows.length) continue;
      const headers = Object.keys(rows[0]||{});
      const m = detectCols(headers);
      for(const r of rows){
        const d = parseDateFlexible(r[m.date]);
        if(!d) continue;
        let v = 1;
        if(m.value && r[m.value]!==undefined && r[m.value]!==null && r[m.value]!==""){
          const n = Number(String(r[m.value]).replace(/[^0-9.-]/g,'')); v = isNaN(n)?0:n;
        }
        allRows.push({
          Source: name,
          Date: toISO(d),
          Order: m.order? (r[m.order]||'') : '',
          Branch: m.branch? (r[m.branch]||'') : '',
          Product: m.product? (r[m.product]||'') : '',
          Team: m.team? (r[m.team]||'') : '',
          Value: v,
        });
      }
    }

    RAW = allRows;
    if(!RAW.length) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Lost / damaged\n‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏ü‡∏•‡πå ‚Üí ‡πÅ‡∏ä‡∏£‡πå ‚Üí ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö)\n‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô Lost, damaged ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå\n‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á');
    }

    // Build filters
    fillSelect('sourceSel', ['(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'].concat(unique(RAW.map(r=>r.Source))));
    fillSelect('branchSel', ['(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'].concat(unique(RAW.map(r=>r.Branch))));
    fillSelect('productSel', ['(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'].concat(unique(RAW.map(r=>r.Product))));
    fillSelect('teamSel', ['(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'].concat(unique(RAW.map(r=>r.Team))));
    // Default dates
    const ds = RAW.map(r=> new Date(r.Date));
    $('startDate').value = toISO(new Date(Math.min(...ds)));
    $('endDate').value = toISO(new Date(Math.max(...ds)));

    ['startDate','endDate','sourceSel','branchSel','productSel','teamSel','topN'].forEach(id=> $(id).addEventListener('change', applyFilters));
    $('exportBtn').addEventListener('click', exportCSV);

    $('status').textContent='Connected'; $('status').style.background='rgba(53,208,171,.25)';
    applyFilters();
  }catch(e){
    console.error(e); $('status').textContent='Error'; $('status').style.background='rgba(255,99,132,.25)'; alert(e.message);
  }
})();

function fillSelect(id, items){ const el=$(id); el.innerHTML=''; items.forEach(x=> el.appendChild(new Option(x,x==='(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'?'':x))); }

function getFiltered(){
  const s = $('startDate').value? new Date($('startDate').value): null;
  const e = $('endDate').value? new Date($('endDate').value): null;
  const src = $('sourceSel').value, b=$('branchSel').value, p=$('productSel').value, t=$('teamSel').value;
  return RAW.filter(r=>{
    const d=new Date(r.Date);
    if(s && d<s) return false; if(e && d>e) return false;
    if(src && r.Source!==src) return false;
    if(b && r.Branch!==b) return false; if(p && r.Product!==p) return false; if(t && r.Team!==t) return false;
    return true;
  });
}

function applyFilters(){
  const rows = getFiltered();
  const total = rows.reduce((a,c)=> a+(+c.Value||0), 0);
  $('kpiTotal').textContent = fmt(total);
  $('kpiCount').textContent = fmt(rows.length);
  const months = groupSum(rows, r=> r.Date.slice(0,7), r=> +r.Value||0).sort((a,b)=> a[0]>b[0]?1:-1);
  const mNow  = months.length ? months[months.length-1] : null;
  const mPrev = months.length>1 ? months[months.length-2] : null;
  $('kpiMonth').textContent = mNow? `${mNow[0]}: ${fmt(mNow[1])}` : '-';
  const delta = (mNow?mNow[1]:0) - (mPrev?mPrev[1]:0);
  $('kpiMoM').textContent = (mPrev && mPrev[1]!==0)? `${delta>0?'+':''}${fmt(delta)} (${((delta/mPrev[1])*100).toFixed(1)}%)` : '‚Äî';

  drawTrend(rows);
  drawBars('branchChart', rows, r=>r.Branch, '‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤');
  drawBars('productChart', rows, r=>r.Product, '‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à');
  drawBars('teamChart', rows, r=>r.Team, '‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°');
  drawDonut(rows);
  renderTable(rows);
}

function drawTrend(rows){
  const byDay = groupSum(rows, r=> r.Date, r=> +r.Value||0).sort((a,b)=> a[0]>b[0]?1:-1);
  makeChart('trendChart',{type:'line', data:{ labels:byDay.map(x=>x[0]), datasets:[{ data:byDay.map(x=>x[1]), tension:.25, fill:true }] }, options:{ plugins:{legend:{display:false}, datalabels:{display:false}}, scales:{y:{beginAtZero:true}} }});
}

function drawBars(id, rows, keyFn, label){
  let arr = groupSum(rows, keyFn, r=> +r.Value||0).filter(x=>x[0]).sort((a,b)=> b[1]-a[1]);
  const top = Math.max(1, +$('topN').value||10); if(arr.length>top){ const other = arr.slice(top).reduce((a,c)=>a+c[1],0); arr = arr.slice(0,top).concat([['‡∏≠‡∏∑‡πà‡∏ô‡πÜ',other]]); }
  makeChart(id,{type:'bar', data:{ labels:arr.map(x=>x[0]), datasets:[{ label, data:arr.map(x=>x[1]) }] }, options:{ indexAxis:'y', plugins:{legend:{display:false}, datalabels:{anchor:'end', align:'right', formatter:v=>fmt(v), color:'#cfe0ff'}}, scales:{x:{beginAtZero:true}}}});
}

function drawDonut(rows){
  const arr = groupSum(rows, r=> r.Source, r=> +r.Value||0).sort((a,b)=> b[1]-a[1]);
  makeChart('donutChart',{type:'doughnut', data:{ labels:arr.map(x=>x[0]), datasets:[{ data:arr.map(x=>x[1]) }] }, options:{ plugins:{ legend:{position:'bottom'}, datalabels:{ formatter:(v,ctx)=>{ const sum=ctx.chart._metasets[0].total||arr.reduce((a,c)=>a+c[1],0); const pct = sum? (v*100/sum):0; return pct>=6? pct.toFixed(1)+'%':''; } } } });
}

function renderTable(rows){
  const thead=$('dataTable').querySelector('thead'); const tbody=$('dataTable').querySelector('tbody');
  const headers=['Date','Source','Order','Branch','Product','Team','Value'];
  thead.innerHTML='<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  tbody.innerHTML=rows.map(r=>`<tr><td>${r.Date}</td><td>${r.Source}</td><td>${r.Order||''}</td><td>${r.Branch||''}</td><td>${r.Product||''}</td><td>${r.Team||''}</td><td class="right">${fmt(r.Value)}</td></tr>`).join('');
}

function makeChart(id, cfg){ const ctx=$(id).getContext('2d'); if(charts[id]) charts[id].destroy(); charts[id]=new Chart(ctx,cfg); return charts[id]; }

function exportCSV(){
  const rows = getFiltered(); if(!rows.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á');
  const header = Object.keys(rows[0]);
  const csv = [header.join(',')].concat(rows.map(r=> header.map(h=> JSON.stringify(r[h]??'')).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='filtered.csv'; a.click();
}
</script>
</body>
</html>
